<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule Builder ‚Ä¢ Vue.js</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fff;}
    .app{max-width:1200px;margin:24px auto;padding:0 16px;}
    h1{font-size:28px;margin:8px 0 16px;text-align:center}
    h2{font-size:18px;margin:24px 0 8px}

    /* ===== Label List ===== */
    .label-table{width:100%;border-collapse:collapse;margin-top:12px;table-layout:auto}
    .label-table th, .label-table td{
      border:1px solid #d1d5db;padding:6px 8px;text-align:left;vertical-align:middle;
    }
    .label-table th{background:#f3f4f6}
    .label-table input{width:100%;box-sizing:border-box;padding:4px 6px}
    .label-col-drag{width:48px;text-align:center}
    .label-col-visible{width:70px;text-align:center}
    .label-col-action{width:110px;text-align:center}
    .row-hidden{opacity:.45;background:#fafafa}

    /* ===== Schedule (centered with flex + padding) ===== */
    .schedule-center{
      display:flex;
      justify-content:center;
      margin-top:40px;
      width:100%;
    }
    .schedule-wrapper{
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:30px;
      background:#fff;
      border-radius:12px;
    }
    .schedule-title{
      font-size:32px;
      font-weight:700;
      margin-bottom:16px;
      text-align:center;
      white-space:nowrap;
    }
    .tz-table{
      border-collapse:collapse;
      table-layout:auto;
      white-space:nowrap;
    }
    .tz-table th, .tz-table td{
      border:1px solid #d1d5db;
      padding:10px 14px;
      text-align:center;
      vertical-align:middle;
    }
    .tz-table th{background:#f3f4f6}
    .tz-col-label{text-align:left;padding-left:10px;white-space:nowrap;}
    .desc{font-size:12px;color:#6b7280;display:block;margin-top:2px;white-space:normal;}

    /* ===== Buttons / Utils ===== */
    .control{margin:8px 0}
    input,button,select{padding:6px 10px;margin:2px;border:1px solid #cbd5e1;border-radius:6px}
    button{cursor:pointer;background:#111827;color:#fff}
    button.ghost{background:#f3f4f6;color:#111827;border-color:#d1d5db}
    button:disabled{opacity:.5;cursor:not-allowed}
    .time{font-feature-settings:"tnum";font-variant-numeric:tabular-nums;font-size:16px;font-weight:700}
    .dow{font-size:12px;color:#6b7280}

    /* Show/Hide toggle button */
    .toggle-btn{
      width:24px;height:24px;border-radius:50%;border:none;cursor:pointer;display:inline-block;
    }
    .toggle-green{background:#16a34a}
    .toggle-red{background:#dc2626}

    .handle{cursor:grab;user-select:none;font-size:18px;line-height:1;display:inline-block;padding:2px 6px;}
    .handle:active{cursor:grabbing;}
    .sortable-ghost{background:#e0f2fe !important;}
    .sortable-chosen{opacity:.9;}

    /* ===== Modal ===== */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;}
    .modal{background:#fff;border-radius:8px;max-width:420px;width:100%;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,.2);}
    .modal h3{margin-top:0;font-size:18px}
    .modal-footer{margin-top:20px;text-align:right}

    /* ===== Footer ===== */
    .footer{
      text-align:center;
      font-size:13px;
      color:#6b7280;
      margin-top:40px;
    }
  </style>
</head>
<body>
<div id="app" class="app">
  <h1>Schedule Builder
    <button type="button" class="ghost" @click="openSettings">‚öôÔ∏è Settings</button>
  </h1>

  <!-- Label List -->
  <h2>Label List</h2>
  <div class="control">
    <button type="button" @click="addLabel">+ Add Label</button>
  </div>
  <table class="label-table">
    <thead>
      <tr>
        <th class="label-col-drag">Drag</th>
        <th class="label-col-visible">Visible</th>
        <th>Label Name</th>
        <th>Description</th>
        <th>Date-Time (GMT-2)</th>
        <th class="label-col-action">Action</th>
      </tr>
    </thead>
    <tbody id="labelTbody">
      <tr v-for="(lab, i) in labels" :key="lab.id" :class="{'row-hidden': !lab.visible}">
        <td class="label-col-drag"><span class="handle" title="Drag to reorder">‚†ø</span></td>
        <td class="label-col-visible" style="text-align:center">
          <button type="button" class="toggle-btn"
            :class="lab.visible ? 'toggle-green' : 'toggle-red'"
            @click="toggleLabelVisible(lab)">
          </button>
        </td>
        <td><input v-model="lab.name" placeholder="Label Name" /></td>
        <td><input v-model="lab.desc" placeholder="Description..." /></td>
        <td><input type="datetime-local" step="60" v-model="lab.dt" /></td>
        <td class="label-col-action" style="text-align:center">
          <button type="button" @click="removeLabel(i)">Remove</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Schedule (centered flex) -->
  <div class="schedule-center">
    <div class="schedule-wrapper" id="scheduleSection">
      <div class="schedule-title">Schedule</div>
      <table class="tz-table">
        <thead>
          <tr>
            <th class="tz-col-label">Label</th>
            <th v-for="t in sortedTargets" :key="'ht-'+t.tz" :title="t.label">{{ t.short }}</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="lab in activeLabels" :key="'r-'+lab.id">
            <td class="tz-col-label">
              {{ lab.name || '‚Äî' }}
              <span v-if="lab.desc" class="desc">{{ lab.desc }}</span>
            </td>
            <td v-for="t in sortedTargets" :key="lab.id+'-'+t.tz">
              <div v-if="lab.dt">
                <div class="time">{{ formatForLabel(lab, t.tz).time }}</div>
                <div class="dow">{{ formatForLabel(lab, t.tz).dow }}</div>
              </div>
              <div v-else>-</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Save button OUTSIDE scheduleSection -->
  <div style="text-align:center; margin-top:16px;">
    <button type="button" @click="saveAsImage">üíæ Save as PNG</button>
  </div>

  <!-- Footer -->
  <div class="footer">
    ¬© 2025 BonesBoom ‚Äî Not affiliated with Last War: Survival or First Fun.
  </div>

  <!-- Modal Settings -->
  <div v-if="showSettings" class="modal-backdrop" @click.self="closeSettings">
    <div class="modal">
      <h3>Settings</h3>
      <div>
        <label>Order Time Zone:</label><br>
        <select v-model="settings.order">
          <option value="asc">Offset ASC (‡∏ô‡πâ‡∏≠‡∏¢‚Üí‡∏°‡∏≤‡∏Å)</option>
          <option value="desc">Offset DESC (‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢)</option>
          <option value="fixed">Fixed Order</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="ghost" @click="clearData">Clear Save Data</button>
        <button type="button" @click="closeSettings">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Vue 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const { createApp, reactive, onMounted, computed, watch } = Vue;

createApp({
  setup() {
    const STORAGE_KEY = "tz-app-data";
    const DEFAULT_SETTINGS = { order:'asc' };
    const DEFAULT_LABELS = [{id:1, name:'Default Label', desc:'', dt:'', visible:true}];

    const ordinal = n => { const s=["th","st","nd","rd"], v=n%100; return n + (s[(v-20)%10] || s[v] || s[0]); };
    const buildUtcFromGmtMinus2 = (dateStr, timeStr) => {
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh,mm] = timeStr.split(':').map(Number);
      return new Date(Date.UTC(y, m-1, d, hh+2, mm, 0, 0));
    };
    const fmtLine = (utcDate, tz) => {
      const dtf = new Intl.DateTimeFormat('en-GB', {
        timeZone: tz, hour12: false, hour:'2-digit', minute:'2-digit',
        year:'numeric', month:'short', day:'2-digit', weekday:'short'
      });
      const parts = Object.fromEntries(dtf.formatToParts(utcDate).map(p=>[p.type,p.value]));
      return { time: `${parts.hour}:${parts.minute}`, dow: `${parts.weekday} ${ordinal(Number(parts.day))}` };
    };
    function getOffsetMinutes(tz) {
      try {
        const s = new Intl.DateTimeFormat('en-US', { timeZone: tz, hour:'2-digit', timeZoneName:'shortOffset' }).format(new Date());
        const m = s.match(/GMT([+-]\d{1,2})(?::(\d{2}))?/i);
        if (m) { const h = parseInt(m[1], 10); const mins = m[2] ? parseInt(m[2], 10) : 0; return h*60+(h>=0?mins:-mins); }
      } catch {}
      return 0;
    }

    let saved = null;
    try { saved = JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch {}
    const normalizeLabels = (arr) =>
      (Array.isArray(arr) ? arr : []).map((l,idx)=>({
        id: l.id ?? Date.now()+idx,
        name: l.name ?? `Label ${idx+1}`,
        desc: l.desc ?? '',
        dt: l.dt ?? '',
        visible: (typeof l.visible === 'boolean') ? l.visible : true
      }));

    const state = reactive({
      labels: (saved?.labels && saved.labels.length) ? normalizeLabels(saved.labels) : DEFAULT_LABELS,
      targets: [
        { tz:'America/Chicago',     label:'CST/CDT - Central Time', short:'CST' },
        { tz:'America/New_York',    label:'EST/EDT - Eastern Time', short:'EST' },
        { tz:'America/Los_Angeles', label:'Los Angeles',            short:'LA'  },
        { tz:'Asia/Manila',         label:'Manila',                 short:'MNL' },
        { tz:'Asia/Bangkok',        label:'Bangkok',                short:'BKK' },
      ],
      showSettings:false,
      settings: saved?.settings || DEFAULT_SETTINGS
    });

    const sortedTargets = computed(() => {
      if (state.settings.order === 'fixed') return state.targets;
      return [...state.targets].map(t=>({...t, offset:getOffsetMinutes(t.tz)}))
        .sort((a,b)=> state.settings.order==='asc' ? a.offset-b.offset : b.offset-a.offset);
    });
    const activeLabels = computed(()=> state.labels.filter(l=>l.visible));

    function formatForLabel(lab, tz){
      if (!lab.dt) return {time:"--:--", dow:""};
      const [dPart, tPart] = lab.dt.split('T');
      const utc = buildUtcFromGmtMinus2(dPart, tPart);
      return fmtLine(utc, tz);
    }

    function addLabel(){ state.labels.push({id:Date.now(), name:`Label ${state.labels.length+1}`, desc:'', dt:'', visible:true}); }
    function removeLabel(i){ if (state.labels.length === 1) { alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 label ‡πÄ‡∏™‡∏°‡∏≠'); return; } state.labels.splice(i,1); }
    function toggleLabelVisible(lab){ lab.visible = !lab.visible; }

    function openSettings(){ state.showSettings=true }
    function closeSettings(){ state.showSettings=false }

    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({ labels:state.labels, settings:state.settings })); }
    watch(()=>state.labels, saveData,{deep:true})
    watch(()=>state.settings, saveData,{deep:true})

    function clearData(){
      localStorage.removeItem(STORAGE_KEY);
      state.labels=[...DEFAULT_LABELS];
      state.settings={...DEFAULT_SETTINGS};
      closeSettings();
    }

    // Save image: capture ONLY scheduleSection, width = table actual width
    async function saveAsImage(){
      const el = document.getElementById("scheduleSection");
      const width = el.scrollWidth || el.offsetWidth;
      const canvas = await html2canvas(el, {
        backgroundColor:"#fff",
        scale: 2,
        width,
        windowWidth: width
      });
      const link = document.createElement("a");
      link.download = "schedule.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }

    onMounted(()=>{
      Sortable.create(document.getElementById("labelTbody"),{
        handle:".handle",animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",
        onEnd:e=>{const m=state.labels.splice(e.oldIndex,1)[0];state.labels.splice(e.newIndex,0,m);}
      })
    })

    return {
      ...state,
      addLabel, removeLabel, toggleLabelVisible,
      formatForLabel, sortedTargets, activeLabels,
      openSettings, closeSettings, clearData,
      saveAsImage
    };
  }
}).mount('#app');
</script>
</body>
</html>
